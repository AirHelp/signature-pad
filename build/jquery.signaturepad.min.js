/*
 SignaturePad: A jQuery plugin for assisting in the creation of an HTML5 canvas
 based signature pad. Records the drawn signature in JSON for later regeneration.

 Dependencies: FlashCanvas 1.5, json2, jquery-1.3.2+

 @project ca.thomasjbradley.applications.signaturepad
 @author Thomas J Bradley <hey@thomasjbradley.ca>
 @link http://thomasjbradley.ca/lab/signature-pad
 @link http://github.com/thomasjbradley/signature-pad
 @copyright Copyright MMXI, Thomas J Bradley
 @license New BSD License
 @version {version}
*/
(function(b){function B(l,p){function r(c,h){var i=b(c.target).offset(),m;clearTimeout(o);o=false;if(typeof c.changedTouches!=="undefined"){m=Math.floor(c.changedTouches[0].pageX-i.left);i=Math.floor(c.changedTouches[0].pageY-i.top)}else{m=Math.floor(c.pageX-i.left);i=Math.floor(c.pageY-i.top)}if(g.x===m&&g.y===i)return true;if(g.x===null)g.x=m;if(g.y===null)g.y=i;if(h)i+=h;e.beginPath();e.moveTo(g.x,g.y);e.lineTo(m,i);e.lineCap=a.penCap;e.stroke();e.closePath();k.push({lx:m,ly:i,mx:g.x,my:g.y});
g.x=m;g.y=i}function n(){q?f.each(function(){this.ontouchmove=null}):f.unbind("mousemove.signaturepad");g.x=null;g.y=null;k.length>0&&b(a.output,d).val(JSON.stringify(k))}function s(){n();e.fillStyle=a.bgColour;e.fillRect(0,0,j.width,j.height);if(!a.displayOnly)if(a.lineWidth){e.beginPath();e.lineWidth=a.lineWidth;e.strokeStyle=a.lineColour;e.moveTo(a.lineMargin,a.lineTop);e.lineTo(j.width-a.lineMargin,a.lineTop);e.stroke();e.closePath()}e.lineWidth=a.penWidth;e.strokeStyle=a.penColour;b(a.output,
d).val("");k=[]}function v(c){q?f.each(function(){this.addEventListener("touchmove",r,false)}):f.bind("mousemove.signaturepad",r);r(c,1)}function C(){t=false;if(q)f.each(function(){this.removeEventListener("touchstart",n);this.removeEventListener("touchend",n);this.removeEventListener("touchmove",r)});else{f.unbind("mousedown.signaturepad");f.unbind("mouseup.signaturepad");f.unbind("mousemove.signaturepad");f.unbind("mouseleave.signaturepad")}b(a.clear,d).unbind("click.signaturepad")}function w(c){if(t)return false;
t=true;if(typeof c.changedTouches!=="undefined")q=true;if(q){f.each(function(){this.addEventListener("touchend",n,false);this.addEventListener("touchcancel",n,false)});f.unbind("mousedown.signaturepad")}else{f.bind("mouseup.signaturepad",function(){n()});f.bind("mouseleave.signaturepad",function(){o||(o=setTimeout(function(){n();clearTimeout(o);o=false},500))});f.each(function(){this.ontouchstart=null})}}function u(){b(a.typed,d).hide();s();f.each(function(){this.ontouchstart=function(c){c.preventDefault();
w(c);v(c,this)}});f.bind("mousedown.signaturepad",function(c){w(c);v(c,this)});b(a.clear,d).bind("click.signaturepad",function(c){c.preventDefault();s()});b(a.typeIt,d).bind("click.signaturepad",function(c){c.preventDefault();x()});b(a.drawIt,d).unbind("mousedown.signaturepad");b(a.drawIt,d).bind("mousedown.signaturepad",function(c){c.preventDefault()});b(a.typeIt,d).removeClass(a.currentClass);b(a.drawIt,d).addClass(a.currentClass);b(a.sig,d).addClass(a.currentClass);b(a.typeItDesc,d).hide();b(a.drawItDesc,
d).show();b(a.clear,d).show()}function x(){s();C();b(a.typed,d).show();b(a.drawIt,d).bind("mousedown.signaturepad",function(c){c.preventDefault();u()});b(a.typeIt,d).unbind("click.signaturepad");b(a.typeIt,d).bind("click.signaturepad",function(c){c.preventDefault()});b(a.output,d).val("");b(a.drawIt,d).removeClass(a.currentClass);b(a.typeIt,d).addClass(a.currentClass);b(a.sig,d).removeClass(a.currentClass);b(a.drawItDesc,d).hide();b(a.clear,d).hide();b(a.typeItDesc,d).show()}function y(c){for(b(a.typed,
d).html(c.replace(/>/g,"&gt;").replace(/</g,"&lt;"));b(a.typed,d).width()>j.width;){c=b(a.typed,d).css("font-size").replace(/px/,"");b(a.typed,d).css("font-size",c-1+"px")}}function z(){var c=true;b("p."+a.errorClass,d).remove();d.removeClass(a.errorClass);b("input, label",d).removeClass(a.errorClass);if(a.drawOnly&&k.length<1){b(l).prepend('<p class="'+a.errorClass+'">'+a.errorMessageDraw+"</p>");c=false}if(b(a.name,d).val()===""){b(l).prepend('<p class="'+a.errorClass+'">'+a.errorMessage+"</p>");
b(a.name,d).focus();b(a.name,d).addClass(a.errorClass);b("label[for="+b(a.name).attr("id")+"]",d).addClass(a.errorClass);c=false}return c}function D(){if(parseFloat((/CPU.+OS ([0-9_]{3}).*AppleWebkit.*Mobile/i.exec(navigator.userAgent)||[0,"4_2"])[1].replace("_","."))<4.1){b.fn.Oldoffset=b.fn.offset;b.fn.offset=function(){var c=b(this).Oldoffset();c.top-=window.scrollY;c.left-=window.scrollX;return c}}b(a.typed,d).bind("selectstart.signaturepad",function(c){return b(c.target).is(":input")});f.bind("selectstart.signaturepad",
function(c){return b(c.target).is(":input")});!j.getContext&&FlashCanvas&&FlashCanvas.initElement(j);if(j.getContext){e=j.getContext("2d");b(a.sig,d).show();if(!a.displayOnly){if(!a.drawOnly){b(a.name,d).bind("keyup.signaturepad",function(){y(b(this).val())});b(a.name,d).bind("blur.signaturepad",function(){y(b(this).val())});b(a.drawIt,d).bind("mousedown.signaturepad",function(c){c.preventDefault();u()})}a.drawOnly||a.defaultAction==="drawIt"?u():x();if(a.validateFields)b(l).is("form")?b(l).bind("submit.signaturepad",
function(){return z()}):b(l).parents("form").bind("submit.signaturepad",function(){return z()});b(a.sigNav,d).show()}}}var A=this,a=b.extend({},b.fn.signaturePad.defaults,p),d=b(l),f=b(a.canvas,d),j=f.get(0),e=null,g={x:null,y:null},k=[],o=false,q=false,t=false;b.extend(A,{init:function(){D()},regenerate:function(c){A.clearCanvas();b(a.typed,d).hide();if(typeof c==="string")c=JSON.parse(c);for(var h in c)if(typeof c[h]==="object"){e.beginPath();e.moveTo(c[h].mx,c[h].my);e.lineTo(c[h].lx,c[h].ly);
e.lineCap=a.penCap;e.stroke();e.closePath();k.push({lx:c[h].lx,ly:c[h].ly,mx:c[h].mx,my:c[h].my})}b(a.output,d).length>0&&b(a.output,d).val(JSON.stringify(k))},clearCanvas:function(){s()},getSignature:function(){return k},getSignatureString:function(){return JSON.stringify(k)},getSignatureImage:function(){return j.toDataURL.apply(j,arguments)}})}b.fn.signaturePad=function(l){var p=null;this.each(function(){p=new B(this,l);p.init()});return p};b.fn.signaturePad.defaults={defaultAction:"typeIt",displayOnly:false,
drawOnly:false,canvas:"canvas",sig:".sig",sigNav:".sigNav",bgColour:"#ffffff",penColour:"#145394",penWidth:2,penCap:"round",lineColour:"#ccc",lineWidth:2,lineMargin:5,lineTop:35,name:".name",typed:".typed",clear:".clearButton",typeIt:".typeIt a",drawIt:".drawIt a",typeItDesc:".typeItDesc",drawItDesc:".drawItDesc",output:".output",currentClass:"current",validateFields:true,errorClass:"error",errorMessage:"Please enter your name",errorMessageDraw:"Please sign the document"}})(jQuery);

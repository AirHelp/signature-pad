/*
 SignaturePad: A jQuery plugin for assisting in the creation of an HTML5 canvas
 based signature pad. Records the drawn signature in JSON for later regeneration.

 Dependencies: FlashCanvas 1.5, json2, jquery-1.3.2+

 @project ca.thomasjbradley.applications.signaturepad
 @author Thomas J Bradley <hey@thomasjbradley.ca>
 @link http://thomasjbradley.ca/lab/signature-pad
 @link http://github.com/thomasjbradley/signature-pad
 @copyright Copyright MMXI, Thomas J Bradley
 @license New BSD License
 @version {version}
*/
(function(b){function B(m,q){function s(c,f){var g=b(c.target).offset(),h;clearTimeout(o);o=false;if(typeof c.changedTouches!=="undefined"){h=Math.floor(c.changedTouches[0].pageX-g.left);g=Math.floor(c.changedTouches[0].pageY-g.top)}else{h=Math.floor(c.pageX-g.left);g=Math.floor(c.pageY-g.top)}if(j.x===h&&j.y===g)return true;if(j.x===null)j.x=h;if(j.y===null)j.y=g;if(f)g+=f;e.beginPath();e.moveTo(j.x,j.y);e.lineTo(h,g);e.lineCap=a.penCap;e.stroke();e.closePath();l.push({lx:h,ly:g,mx:j.x,my:j.y});
j.x=h;j.y=g}function n(){r?i.each(function(){this.ontouchmove=null}):i.unbind("mousemove.signaturepad");j.x=null;j.y=null;l.length>0&&b(a.output,d).val(JSON.stringify(l))}function t(){n();e.fillStyle=a.bgColour;e.fillRect(0,0,k.width,k.height);if(!a.displayOnly)if(a.lineWidth){e.beginPath();e.lineWidth=a.lineWidth;e.strokeStyle=a.lineColour;e.moveTo(a.lineMargin,a.lineTop);e.lineTo(k.width-a.lineMargin,a.lineTop);e.stroke();e.closePath()}e.lineWidth=a.penWidth;e.strokeStyle=a.penColour;b(a.output,
d).val("");l=[]}function w(c){r?i.each(function(){this.addEventListener("touchmove",s,false)}):i.bind("mousemove.signaturepad",s);s(c,1)}function C(){u=false;if(r)i.each(function(){this.removeEventListener("touchstart",n);this.removeEventListener("touchend",n);this.removeEventListener("touchmove",s)});else{i.unbind("mousedown.signaturepad");i.unbind("mouseup.signaturepad");i.unbind("mousemove.signaturepad");i.unbind("mouseleave.signaturepad")}b(a.clear,d).unbind("click.signaturepad")}function x(c){if(u)return false;
u=true;if(typeof c.changedTouches!=="undefined")r=true;if(r){i.each(function(){this.addEventListener("touchend",n,false);this.addEventListener("touchcancel",n,false)});i.unbind("mousedown.signaturepad")}else{i.bind("mouseup.signaturepad",function(){n()});i.bind("mouseleave.signaturepad",function(){o||(o=setTimeout(function(){n();clearTimeout(o);o=false},500))});i.each(function(){this.ontouchstart=null})}}function v(){b(a.typed,d).hide();t();i.each(function(){this.ontouchstart=function(c){c.preventDefault();
x(c);w(c,this)}});i.bind("mousedown.signaturepad",function(c){x(c);w(c,this)});b(a.clear,d).bind("click.signaturepad",function(c){c.preventDefault();t()});b(a.typeIt,d).bind("click.signaturepad",function(c){c.preventDefault();y()});b(a.drawIt,d).unbind("mousedown.signaturepad");b(a.drawIt,d).bind("mousedown.signaturepad",function(c){c.preventDefault()});b(a.typeIt,d).removeClass(a.currentClass);b(a.drawIt,d).addClass(a.currentClass);b(a.sig,d).addClass(a.currentClass);b(a.typeItDesc,d).hide();b(a.drawItDesc,
d).show();b(a.clear,d).show()}function y(){t();C();b(a.typed,d).show();b(a.drawIt,d).bind("mousedown.signaturepad",function(c){c.preventDefault();v()});b(a.typeIt,d).unbind("click.signaturepad");b(a.typeIt,d).bind("click.signaturepad",function(c){c.preventDefault()});b(a.output,d).val("");b(a.drawIt,d).removeClass(a.currentClass);b(a.typeIt,d).addClass(a.currentClass);b(a.sig,d).removeClass(a.currentClass);b(a.drawItDesc,d).hide();b(a.clear,d).hide();b(a.typeItDesc,d).show()}function z(c){for(b(a.typed,
d).html(c.replace(/>/g,"&gt;").replace(/</g,"&lt;"));b(a.typed,d).width()>k.width;){c=b(a.typed,d).css("font-size").replace(/px/,"");b(a.typed,d).css("font-size",c-1+"px")}}function D(c,f,g){b("p."+g.errorClass,f).remove();f.removeClass(g.errorClass);b("input, label",f).removeClass(g.errorClass)}function E(c,f,g,h){if(c.nameInvalid){b(f).prepend(['<p class="',h.errorClass,'">',h.errorMessage,"</p>"].join(""));b(h.name,g).focus();b(h.name,g).addClass(h.errorClass);b("label[for="+b(h.name).attr("id")+
"]",g).addClass(h.errorClass)}c.drawInvalid&&b(f).prepend(['<p class="',h.errorClass,'">',h.errorMessageDraw,"</p>"].join(""))}function A(){var c=true,f={},g=[m,d,a],h=[f,m,d,a];a.onBeforeValidate&&typeof a.onBeforeValidate==="function"?a.onBeforeValidate.apply(p,g):D.apply(p,g);if(a.drawOnly&&l.length<1){f.drawInvalid=true;c=false}if(b(a.name,d).val()===""){f.nameInvalid=true;c=false}a.onFormError&&typeof a.onFormError==="function"?a.onFormError.apply(p,h):E.apply(p,h);return c}function F(){if(parseFloat((/CPU.+OS ([0-9_]{3}).*AppleWebkit.*Mobile/i.exec(navigator.userAgent)||
[0,"4_2"])[1].replace("_","."))<4.1){b.fn.Oldoffset=b.fn.offset;b.fn.offset=function(){var c=b(this).Oldoffset();c.top-=window.scrollY;c.left-=window.scrollX;return c}}b(a.typed,d).bind("selectstart.signaturepad",function(c){return b(c.target).is(":input")});i.bind("selectstart.signaturepad",function(c){return b(c.target).is(":input")});!k.getContext&&FlashCanvas&&FlashCanvas.initElement(k);if(k.getContext){e=k.getContext("2d");b(a.sig,d).show();if(!a.displayOnly){if(!a.drawOnly){b(a.name,d).bind("keyup.signaturepad",
function(){z(b(this).val())});b(a.name,d).bind("blur.signaturepad",function(){z(b(this).val())});b(a.drawIt,d).bind("mousedown.signaturepad",function(c){c.preventDefault();v()})}a.drawOnly||a.defaultAction==="drawIt"?v():y();if(a.validateFields)b(m).is("form")?b(m).bind("submit.signaturepad",function(){return A()}):b(m).parents("form").bind("submit.signaturepad",function(){return A()});b(a.sigNav,d).show()}}}var p=this,a=b.extend({},b.fn.signaturePad.defaults,q),d=b(m),i=b(a.canvas,d),k=i.get(0),
e=null,j={x:null,y:null},l=[],o=false,r=false,u=false;b.extend(p,{init:function(){F()},regenerate:function(c){p.clearCanvas();b(a.typed,d).hide();if(typeof c==="string")c=JSON.parse(c);for(var f in c)if(typeof c[f]==="object"){e.beginPath();e.moveTo(c[f].mx,c[f].my);e.lineTo(c[f].lx,c[f].ly);e.lineCap=a.penCap;e.stroke();e.closePath();l.push({lx:c[f].lx,ly:c[f].ly,mx:c[f].mx,my:c[f].my})}b(a.output,d).length>0&&b(a.output,d).val(JSON.stringify(l))},clearCanvas:function(){t()},getSignature:function(){return l},
getSignatureString:function(){return JSON.stringify(l)},getSignatureImage:function(){return k.toDataURL.apply(k,arguments)}})}b.fn.signaturePad=function(m){var q=null;this.each(function(){q=new B(this,m);q.init()});return q};b.fn.signaturePad.defaults={defaultAction:"typeIt",displayOnly:false,drawOnly:false,canvas:"canvas",sig:".sig",sigNav:".sigNav",bgColour:"#ffffff",penColour:"#145394",penWidth:2,penCap:"round",lineColour:"#ccc",lineWidth:2,lineMargin:5,lineTop:35,name:".name",typed:".typed",clear:".clearButton",
typeIt:".typeIt a",drawIt:".drawIt a",typeItDesc:".typeItDesc",drawItDesc:".drawItDesc",output:".output",currentClass:"current",validateFields:true,errorClass:"error",errorMessage:"Please enter your name",errorMessageDraw:"Please sign the document",onBeforeValidate:null,onFormError:null}})(jQuery);

/*
 SignaturePad: A jQuery plugin for assisting in the creation of an HTML5 canvas
 based signature pad. Records the drawn signature in JSON for later regeneration.

 Dependencies: FlashCanvas 1.5, json2, jquery-1.3.2+

 @project ca.thomasjbradley.applications.signaturepad
 @author Thomas J Bradley <hey@thomasjbradley.ca>
 @link http://thomasjbradley.ca/lab/signature-pad
 @link http://github.com/thomasjbradley/signature-pad
 @copyright Copyright MMXI, Thomas J Bradley
 @license New BSD License
 @version 2.0.1
*/
(function(b){function A(l,p){function r(){b(a.typed,c).hide();q();g.bind("mousedown.signaturepad",function(d){t(d,this)});g.bind("mouseup.signaturepad",function(){o()});g.bind("mouseleave.signaturepad",function(){n||(n=setTimeout(function(){o();clearTimeout(n);n=false},200))});typeof this.ontouchstart!="undefined"&&g.each(function(){this.ontouchstart=function(d){d.preventDefault();t(d,this)};this.ontouchend=function(){o()};this.ontouchcancel=function(){o()}});b(a.clear,c).bind("click.signaturepad",
function(){q();return false});b(a.typeIt,c).bind("click.signaturepad",function(){u();return false});b(a.drawIt,c).unbind("click.signaturepad");b(a.drawIt,c).bind("click.signaturepad",function(){return false});b(a.typeIt,c).removeClass(a.currentClass);b(a.drawIt,c).addClass(a.currentClass);b(a.sig,c).addClass(a.currentClass);b(a.typeItDesc,c).hide();b(a.drawItDesc,c).show();b(a.clear,c).show()}function u(){q();g.unbind("mousedown.signaturepad");g.unbind("mouseup.signaturepad");g.unbind("mousemove.signaturepad");
g.unbind("mouseleave.signaturepad");b(a.clear,c).unbind("click.signaturepad");b(a.typed,c).show();b(a.drawIt,c).bind("click.signaturepad",function(){r();return false});b(a.typeIt,c).unbind("click.signaturepad");b(a.typeIt,c).bind("click.signaturepad",function(){return false});b(a.output,c).val("");b(a.drawIt,c).removeClass(a.currentClass);b(a.typeIt,c).addClass(a.currentClass);b(a.sig,c).removeClass(a.currentClass);b(a.drawItDesc,c).hide();b(a.clear,c).hide();b(a.typeItDesc,c).show()}function v(d){for(b(a.typed,
c).html(d.replace(/>/g,"&gt;").replace(/</g,"&lt;"));b(a.typed,c).width()>i.width;){d=b(a.typed,c).css("font-size").replace(/px/,"");b(a.typed,c).css("font-size",d-1+"px")}}function t(){g.bind("mousemove.signaturepad",function(d){w(d,this)});typeof this.ontouchstart!="undefined"&&g.each(function(){this.ontouchmove=function(d){var e,j;j=b(document).scrollTop();e=0;var m,s,x;if(j>0){m=this.offsetTop-b(this).offset().top;b(document).scrollTop(0);e=this.offsetTop-b(this).offset().top;b(document).scrollTop(j)}j=
b(document).scrollLeft();s=0;if(j>0){x=this.offsetLeft-b(this).offset().left;b(document).scrollLeft(0);s=this.offsetLeft-b(this).offset().left;b(document).scrollLeft(j)}e={top:m!=e?b(document).scrollTop():0,left:x!=s?b(document).scrollLeft():0};w(d,this,e)}})}function o(){g.unbind("mousemove.signaturepad");typeof this.ontouchstart!="undefined"&&g.each(function(){this.ontouchmove=null});h.x=null;h.y=null;k.length>0&&b(a.output,c).val(JSON.stringify(k))}function w(d,e,j){var m=b(e).offset();clearTimeout(n);
n=false;if(typeof d.changedTouches!="undefined"){e=Math.floor(d.changedTouches[0].pageX-m.left+j.left);d=Math.floor(d.changedTouches[0].pageY-m.top+j.top)}else{e=Math.floor(d.pageX-m.left);d=Math.floor(d.pageY-m.top)}if(h.x===null)h.x=e;if(h.y===null)h.y=d;f.beginPath();f.moveTo(h.x,h.y);f.lineTo(e,d);f.lineCap=a.penCap;f.stroke();f.closePath();k.push({lx:e,ly:d,mx:h.x,my:h.y});h.x=e;h.y=d}function q(){o();f.clearRect(0,0,i.width,i.height);if(!a.displayOnly){f.beginPath();f.lineWidth=a.lineWidth;
f.strokeStyle=a.lineColour;f.moveTo(a.lineMargin,a.lineTop);f.lineTo(i.width-a.lineMargin,a.lineTop);f.stroke();f.closePath()}f.lineWidth=a.penWidth;f.strokeStyle=a.penColour;b(a.output,c).val("");k=[]}function y(){var d=true;b("p."+a.errorClass,c).remove();c.removeClass(a.errorClass);b("input, label",c).removeClass(a.errorClass);if(a.drawOnly&&k.length<1){b(l).prepend('<p class="'+a.errorClass+'">'+a.errorMessageDraw+"</p>");d=false}if(b(a.name,c).val()===""){b(l).prepend('<p class="'+a.errorClass+
'">'+a.errorMessage+"</p>");b(a.name,c).focus();b(a.name,c).addClass(a.errorClass);b("label[for="+b(a.name).attr("id")+"]",c).addClass(a.errorClass);d=false}return d}var z=this,a=b.extend({},b.fn.signaturePad.defaults,p),c=b(l),g=b(a.canvas,c),i=g.get(0),f=null,h={x:null,y:null},k=[],n=false;b(a.typed,c).bind("selectstart.signaturepad",function(d){return b(d.target).is(":input")});g.bind("selectstart.signaturepad",function(d){return b(d.target).is(":input")});i.getContext||FlashCanvas.initElement(i);
if(i.getContext){f=i.getContext("2d");b(a.sig,c).show();if(!a.displayOnly){if(!a.drawOnly){b(a.name,c).bind("keyup.signaturepad",function(){v(b(this).val())});b(a.name,c).bind("blur.signaturepad",function(){v(b(this).val())});b(a.drawIt,c).bind("click.signaturepad",function(){r();return false})}a.drawOnly||a.defaultAction=="drawIt"?r():u();if(a.validateFields)b(l).is("form")?b(l).bind("submit.signaturepad",function(){return y()}):b(l).parents("form").bind("submit.signaturepad",function(){return y()});
b(a.typeItDesc,c).show();b(a.sigNav,c).show()}}b.extend(z,{regenerate:function(d){z.clearCanvas();b(a.typed,c).hide();if(typeof d==="string")d=JSON.parse(d);for(var e in d)if(typeof d[e]==="object"){f.beginPath();f.moveTo(d[e].mx,d[e].my);f.lineTo(d[e].lx,d[e].ly);f.lineCap=a.penCap;f.stroke();f.closePath();k.push({lx:d[e].lx,ly:d[e].ly,mx:d[e].mx,my:d[e].my})}b(a.output,c).length>0&&b(a.output,c).val(JSON.stringify(k))},clearCanvas:function(){q()},getSignature:function(){return k},getSignatureString:function(){return JSON.stringify(k)},
getSignatureImage:function(){return i.toDataURL()}})}b.fn.signaturePad=function(l){var p=null;this.each(function(){p=new A(this,l)});return p};b.fn.signaturePad.defaults={defaultAction:"typeIt",displayOnly:false,drawOnly:false,canvas:"canvas",sig:".sig",sigNav:".sigNav",bgColour:"#fff",penColour:"#145394",penWidth:2,penCap:"round",lineColour:"#ccc",lineWidth:2,lineMargin:5,lineTop:35,name:".name",typed:".typed",clear:".clearButton",typeIt:".typeIt a",drawIt:".drawIt a",typeItDesc:".typeItDesc",drawItDesc:".drawItDesc",
output:".output",currentClass:"current",validateFields:true,errorClass:"error",errorMessage:"Please enter your name",errorMessageDraw:"Please sign the document"}})(jQuery);
